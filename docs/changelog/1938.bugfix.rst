Fix a bug that reading and writing on the same file may cause race on multiple processes.
